<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kindergarten Schedule Input (Pre-filled)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the schedule display */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font as per instructions */
            margin: 20px;
            background-color: #f4f7f6;
            color: #333;
        }

        /* Container for all week schedules */
        #schedule-container {
            display: flex;
            flex-direction: column;
            gap: 40px; /* Space between each week's table */
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Styling for each individual week's schedule block */
        .schedule-week {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            padding: 25px;
            border-radius: 12px; /* Rounded corners for the week blocks */
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.2s ease-in-out;
        }

        .schedule-week:hover {
            transform: translateY(-5px); /* Slight lift effect on hover */
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 700;
        }

        h2.section-title { /* Added a class for main section titles */
            color: #34495e;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        /* Table styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 8px; /* Rounded corners for the table */
            overflow: hidden; /* Ensures rounded corners are visible */
        }

        th, td {
            border: 1px solid #e0e0e0;
            padding: 12px;
            text-align: left;
            vertical-align: top;
            font-size: 0.95em;
        }

        th {
            background-color: #f0f4f7;
            color: #4a69bd;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Styling for individual activity items within a cell */
        .activity-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #f0f0f0;
        }

        .activity-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .activity-item strong {
            color: #2980b9;
            font-weight: 700;
            display: block; /* Ensures name is on its own line */
            margin-bottom: 3px;
        }

        .activity-item span {
            display: block; /* Ensures each detail is on its own line */
            font-size: 0.85em;
            color: #666;
            line-height: 1.4;
        }

        .notes {
            font-style: italic;
            color: #888;
            margin-top: 5px;
        }

        /* Responsive adjustments for tables */
        @media (max-width: 768px) {
            body {
                margin: 10px;
            }
            #schedule-container {
                padding: 10px;
            }
            .schedule-week {
                padding: 15px;
            }
            h1 {
                font-size: 1.8em;
            }
            h2.section-title {
                font-size: 1.4em;
            }
            th, td {
                padding: 8px;
                font-size: 0.85em;
            }
            table, thead, tbody, th, td, tr {
                display: block; /* Stack table elements for small screens */
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr { border: 1px solid #ccc; margin-bottom: 15px; border-radius: 8px; overflow: hidden;}
            td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            td:before {
                position: absolute;
                top: 6px;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: #555;
            }
            /* Label the data cells with the corresponding column header */
            td:nth-of-type(1):before { content: "Time Slot:"; }
            td:nth-of-type(2):before { content: "Monday:"; }
            td:nth-of-type(3):before { content: "Tuesday:"; }
            td:nth-of-type(4):before { content: "Wednesday:"; }
            td:nth-of-type(5):before { content: "Thursday:"; }
            td:nth-of-type(6):before { content: "Friday:"; }
        }
        .progress-circle {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: #e2e8f0; /* Light gray background */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Hide overflow for the pseudo-elements */
        }
        .progress-circle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                #22c55e var(--progress, 0%), /* Green for progress */
                #cbd5e1 var(--progress, 0%) /* Light gray for remaining */
            );
            z-index: 1;
        }
        .progress-circle-inner {
            position: relative;
            z-index: 2;
            background-color: white;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            color: #16a34a; /* text-green-700 */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased p-8">
    <nav class="bg-blue-600 p-4 shadow-lg rounded-lg">
        <ul class="flex justify-center space-x-8">
            <li>
                <a href="/Kindergarten/" class="text-white text-lg font-semibold hover:text-blue-200 transition duration-300">Home</a>
            </li>
            <!-- <li>
                <a href="/editor/" class="text-white text-lg font-semibold hover:text-blue-200 transition duration-300">Editor</a>
            </li> -->
        </ul>
    </nav>

    <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-xl p-8">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-8 text-center">Kindergarten Schedule Data Input</h1>

        <form onsubmit="Kindergarten(event)" id="scheduleInputForm">

            <section class="mb-10 p-6 bg-blue-50 rounded-lg border-l-4 border-blue-500 shadow-md">
                <h2 class="text-2xl font-bold text-blue-800 mb-6">General Schedule Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="starting_date" class="block text-sm font-medium text-gray-700 mb-1">Starting Date</label>
                        <input type="date" id="starting_date" name="starting_date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="2024-06-01" required>
                    </div>
                    <div>
                        <label for="ending_date" class="block text-sm font-medium text-gray-700 mb-1">Ending Date</label>
                        <input type="date" id="ending_date" name="ending_date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="2024-06-30" required>
                    </div>
                    <div>
                        <label for="rooms" class="block text-sm font-medium text-gray-700 mb-1">Number of Rooms</label>
                        <input type="number" id="rooms" name="rooms" min="1" value="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                    </div>

                    <div>
                        <label for="no_of_pedagogues" class="block text-sm font-medium text-gray-700 mb-1">No. of Pedagogues</label>
                        <input type="number" id="no_of_pedagogues" name="no_of_pedagogues" min="0" value="6" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="generateStaffFields('pedagogue')" onkeyup="generateStaffFields('pedagogue')" required>
                    </div>
                    <div>
                        <label for="no_of_assistants" class="block text-sm font-medium text-gray-700 mb-1">No. of Assistants</label>
                        <input type="number" id="no_of_assistants" name="no_of_assistants" min="0" value="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="generateStaffFields('assistant')" onkeyup="generateStaffFields('assistant')" required>
                    </div>
                    <div>
                        <label for="no_of_helpers" class="block text-sm font-medium text-gray-700 mb-1">No. of Helpers</label>
                        <input type="number" id="no_of_helpers" name="no_of_helpers" min="0" value="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="generateStaffFields('helper')" onkeyup="generateStaffFields('helper')" required>
                    </div>
                </div>
            </section>

            <section class="mb-10">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Staff Details</h2>

                <div class="mb-8 p-6 bg-green-50 rounded-lg border-l-4 border-green-500 shadow-md">
                    <h3 class="text-xl font-bold text-green-800 mb-4">Pedagogues</h3>
                    <div id="pedagogue_fields_container">
                        </div>
                </div>

                <div class="mb-8 p-6 bg-purple-50 rounded-lg border-l-4 border-purple-500 shadow-md">
                    <h3 class="text-xl font-bold text-purple-800 mb-4">Assistants</h3>
                    <div id="assistant_fields_container">
                        </div>
                </div>

                <div class="mb-8 p-6 bg-yellow-50 rounded-lg border-l-4 border-yellow-500 shadow-md">
                    <h3 class="text-xl font-bold text-yellow-800 mb-4">Helpers</h3>
                    <div id="helper_fields_container">
                        </div>
                </div>
            </section>

            <section class="mb-10">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Constraints</h2>

                <div class="mb-8 p-6 bg-red-50 rounded-lg border-l-4 border-red-500 shadow-md">
                    <h3 class="text-xl font-bold text-red-800 mb-4">Hard Constraints</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="hard_constraint_1" class="block text-sm font-medium text-gray-700 mb-1">Rule no 1:</label>
                            <input type="text" id="hard_constraint_1" name="hard_constraints[Rule no 1]" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="No shift exceeds 6 hours without a break;" required>
                        </div>
                        <div>
                            <label for="hard_constraint_2" class="block text-sm font-medium text-gray-700 mb-1">Rule no 2:</label>
                            <input type="text" id="hard_constraint_2" name="hard_constraints[Rule no 2]" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="At least 1 pedagogue per room;" required>
                        </div>
                        <div>
                            <label for="hard_constraint_3" class="block text-sm font-medium text-gray-700 mb-1">Rule no 3:</label>
                            <input type="text" id="hard_constraint_3" name="hard_constraints[Rule no 3]" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="Legal child:adult ratios met per room type;" required>
                        </div>
                        <div>
                            <label for="hard_constraint_4" class="block text-sm font-medium text-gray-700 mb-1">Rule no 4:</label>
                            <input type="text" id="hard_constraint_4" name="hard_constraints[Rule no 4]" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="Staff not assigned during unavailable times;" required>
                        </div>
                        <div>
                            <label for="hard_constraint_5" class="block text-sm font-medium text-gray-700 mb-1">Rule no 5:</label>
                            <input type="text" id="hard_constraint_5" name="hard_constraints[Rule no 5]" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" value="Helpers never left alone" required>
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-indigo-50 rounded-lg border-l-4 border-indigo-500 shadow-md">
                    <h3 class="text-xl font-bold text-indigo-800 mb-4">Soft Constraints</h3>
                    <textarea id="soft_constraints" name="soft_constraints" rows="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., No staff opens and closes on the same day; Max 3 opens or closes per staff per week; Balanced distribution of Friday cleanup; Respect for preferred roles/rooms" required>No staff opens and closes on the same day; Max 3 opens or closes per staff per week; Balanced distribution of Friday cleanup; Respect for preferred roles/rooms</textarea>
                </div>
            </section>

            <div class="mt-10 flex justify-center">
                <button type="submit" class="px-8 py-3 bg-blue-600 text-white text-xl font-semibold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-offset-2">Generate Schedule</button>
            </div>
            
            <div id="loading_spinner" class="hidden mt-8 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
                <p class="text-gray-700 mt-2">Generating schedule, please wait...</p>
            </div>
        </form>

        <section id="schedule_output_section" class="hidden mt-12 p-8 bg-white rounded-lg shadow-xl border-t-4 border-green-600">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center section-title">Generated Schedule & Report</h2>

            <div id="error_message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Error!</strong>
                <span class="block sm:inline" id="error_text">Something went wrong. Please try again.</span>
            </div>

            <!-- This div will now contain the dynamically generated tables -->
            <div class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">GPT Provided Schedule:</h3>
                <div id="dynamic_schedule_tables">
                    <!-- Tables will be rendered here by JavaScript -->
                </div>
                <p class="text-xs text-gray-500 mt-1">The schedule above is generated dynamically. You can review it here.</p>
            </div>

            <div class="max-w-6xl mx-auto">
                <h1 class="text-4xl font-extrabold text-gray-900 mb-10 text-center">AI Model Analysis Dashboard</h1>
        
                <!-- Model Report Overview -->
                <div class="mb-8 p-6 bg-white rounded-xl shadow-lg border border-gray-100 transform transition duration-300 hover:shadow-xl">
                    <div class="flex items-center mb-4">
                        <!-- Icon for Model Report -->
                        <svg class="w-8 h-8 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-2m3 2v-2m2 1.5V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-2.5m-11 0h.02"></path></svg>
                        <h3 class="text-2xl font-bold text-blue-800">Model Report Overview</h3>
                    </div>
                    <p id="model_report_text" class="text-gray-700 mb-4 leading-relaxed border-l-4 border-blue-400 pl-4"></p>
                    <ul id="model_report_details" class="list-disc list-inside text-gray-600 space-y-2 ml-4"></ul>
                </div>
                <!-- Key Performance Indicators -->
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-gray-200 pb-3">Key Performance Indicators</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Fairness Score Card -->
                        <div class="flex flex-col items-center justify-center p-6 bg-white rounded-xl shadow-md border border-gray-100 transform transition duration-300 hover:shadow-lg">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">Fairness Score</h3>
                            <!-- Circular Progress Bar -->
                            <div class="progress-circle" style="--progress: 0%;">
                                <div class="progress-circle-inner" id="fairness_score_output"></div>
                            </div>
                            <p class="text-sm text-gray-500 mt-3 text-center">Reflects model bias and equitable outcomes across groups.</p>
                        </div>
        
                        <!-- Hard Rule Violations Card -->
                        <div class="p-6 bg-white rounded-xl shadow-md border border-gray-100 flex flex-col items-center justify-center transform transition duration-300 hover:shadow-lg">
                            <p class="text-lg font-semibold text-gray-700 mb-3">Hard Rule Violations</p>
                            <div class="flex items-center">
                                <!-- Warning Icon -->
                                <svg class="w-10 h-10 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                <p id="hard_rule_violations_output" class="font-bold text-red-600"></p>
                            </div>
                            <p class="text-sm text-gray-500 mt-2 text-center">Number of critical policy or ethical breaches detected.</p>
                        </div>
        
                        <!-- Correction Time Card -->
                        <div class="p-6 bg-white rounded-xl shadow-md border border-gray-100 flex flex-col items-center justify-center transform transition duration-300 hover:shadow-lg">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">Correction Time</h3>
                            <div class="flex items-center">
                                <!-- Clock Icon -->
                                <svg class="w-10 h-10 text-indigo-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <p id="correction_time_output" class="text-3xl font-bold text-indigo-600"></p>
                            </div>
                            <p class="text-sm text-gray-500 mt-2 text-center">Average time taken for automated corrections.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resource Utilization -->
            <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-gray-200 pb-3">Resource Utilization</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Token Details Card -->
                        <div class="p-6 bg-white rounded-xl shadow-md border border-gray-100 transform transition duration-300 hover:shadow-lg">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                <!-- Token Icon -->
                                <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>
                                Token Details
                            </h3>
                            <div class="space-y-3">
                                <p class="text-gray-600 flex justify-between items-center">
                                    Input Tokens: <span id="input_token_output" class="font-bold text-blue-600"></span>
                                </p>
                                <p class="text-gray-600 flex justify-between items-center">
                                    Output Tokens: <span id="output_token_output" class="font-bold text-purple-600"></span>
                                </p>
                                <p class="text-gray-600 flex justify-between items-center">
                                    Cost: <span id="token_cost_output" class="font-bold text-green-700"></span>
                                </p>
                            </div>
                        </div>
        
                        <!-- Overall Metrics Card -->
                        <div class="p-6 bg-white rounded-xl shadow-md border border-gray-100 transform transition duration-300 hover:shadow-lg">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                <!-- Metrics Icon -->
                                <svg class="w-6 h-6 text-orange-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                                Overall Metrics
                            </h3>
                            <div class="space-y-3">
                                <p class="text-gray-600 flex justify-between items-center">
                                    Total Cost: <span id="total_cost_output" class="font-bold text-green-800 text-xl"></span>
                                </p>
                                <p class="text-gray-600 flex justify-between items-center">
                                    Model Used: <span id="model_output" class="font-semibold text-gray-800"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <script>
        // REPLACE THIS WITH YOUR ACTUAL DJANGO BACKEND URL
        // const DJANGO_BACKEND_URL = 'https://mrwajhi.pythonanywhere.com/Kindergarten/'; // Example: Adjust this URL as needed
        const DJANGO_BACKEND_URL = 'http://127.0.0.1:8000/Kindergarten/'; // Example: Adjust this URL as needed

        // Default staff data to pre-fill the fields
        const defaultStaffData = {
            pedagogues: [
                { "name": "P1", "age": 12, "shift_time": "07:30 am - 02:00 pm", "certifification": true, "availability": "Mon-Fri", "Target": 40, "Soft_Preferences": "can do off in a week", "opt_in_opens": true, "opt_in_lates": false, "FLEX/FLOAT_staff": true },
                { "name": "P2", "age": 15, "shift_time": "08:00 am - 04:00 pm", "certifification": true, "availability": "Mon-Thu", "Target": 45, "Soft_Preferences": "can take short leaves", "opt_in_opens": true, "opt_in_lates": true, "FLEX/FLOAT_staff": false },
                { "name": "P3", "age": 16, "shift_time": "09:00 am - 01:00 pm", "certifification": false, "availability": "Only works 09:00-13:00", "Target": 30, "Soft_Preferences": "can come late", "opt_in_opens": true, "opt_in_lates": false, "FLEX/FLOAT_staff": true },
                { "name": "P4", "age": 18, "shift_time": "08:00 am - 04:00 pm", "certifification": true, "availability": "Only works 08:00-16:00", "Target": 40, "Soft_Preferences": "can do off in a week", "opt_in_opens": true, "opt_in_lates": true, "FLEX/FLOAT_staff": false },
                { "name": "P5", "age": 20, "shift_time": "07:00 am - 01:00 pm", "certifification": false, "availability": "Mon-Wed, 07:00-13:00", "Target": 35, "Soft_Preferences": "can do late shifts", "opt_in_opens": true, "opt_in_lates": false, "FLEX/FLOAT_staff": false },
                { "name": "P6", "age": 22, "shift_time": "09:00 am - 05:15 pm", "certifification": true, "availability": "Not available on Fridays", "Target": 40, "Soft_Preferences": "can work from home", "opt_in_opens": false, "opt_in_lates": false, "FLEX/FLOAT_staff": false }
            ],
            assistants: [
                { "name": "A1", "age": 18, "shift_time": "09:00 am - 06:00 pm", "certifification": false, "availability": "Mon-Fri", "Target": 45, "Soft_Preferences": "can be late for only one hour", "opt_in_opens": true, "opt_in_lates": false },
                { "name": "A2", "age": 16, "shift_time": "09:00 am - 06:00 pm", "certifification": true, "availability": "Mon-Fri", "Target": 35, "Soft_Preferences": "can do off in a week", "opt_in_opens": false, "opt_in_lates": true },
                { "name": "A3", "age": 18, "shift_time": "09:00 am - 06:00 pm", "certifification": false, "availability": "Mon-Thu", "Target": 30, "Soft_Preferences": "can do one off in a week", "opt_in_opens": true, "opt_in_lates": false },
                { "name": "A4", "age": 19, "shift_time": "09:00 am - 06:00 pm", "certifification": true, "availability": "Mon-Fri", "Target": 40, "Soft_Preferences": "can do zero off in a week except weekend", "opt_in_opens": true, "opt_in_lates": false },
                { "name": "A5", "age": 20, "shift_time": "09:00 am - 06:00 pm", "certifification": false, "availability": "Mon-Wed", "Target": 40, "Soft_Preferences": "can do off in a week", "opt_in_opens": true, "opt_in_lates": false }
            ],
            helpers: [
                { "name": "H1", "age": 15, "shift_time": "09:00 am - 04:00 pm", "certifification": false, "availability": "Mon-Fri", "Target": 40, "Soft_Preferences": "can come late for 2 hours", "opt_in_opens": true, "opt_in_lates": false },
                { "name": "H2", "age": 16, "shift_time": "09:00 am - 06:00 pm", "certifification": true, "availability": "Mon-Fri", "Target": 40, "Soft_Preferences": "can take off early", "opt_in_opens": false, "opt_in_lates": true }
            ]
        };

        // Templates for staff member input blocks - updated to allow pre-filling
        const pedagogueTemplate = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4 p-4 border border-green-200 rounded-md bg-white staff-member-block">
                <div class="col-span-full text-lg font-semibold text-green-700 mb-2">Pedagogue [INDEX_DISPLAY]</div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" name="pedagogues[[INDEX_ARRAY]][name]" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., P" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Age</label>
                    <input type="number" name="pedagogues[[INDEX_ARRAY]][age]" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Shift Time</label>
                    <input type="text" name="pedagogues[[INDEX_ARRAY]][shift_time]" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., 9:00 am - 6:00 pm" required>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" name="pedagogues[[INDEX_ARRAY]][certifification]" value="True" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                    <label class="ml-2 block text-sm text-gray-900">Certified</label>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Availability</label>
                    <input type="text" name="pedagogues[[INDEX_ARRAY]][availability]" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., Mon-Fri" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Target Hours</label>
                    <input type="number" name="pedagogues[[INDEX_ARRAY]][Target]" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="col-span-full">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Soft Preferences</label>
                    <textarea name="pedagogues[[INDEX_ARRAY]][Soft_Preferences]" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., can do off in a week"></textarea>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" name="pedagogues[[INDEX_ARRAY]][opt_in_opens]" value="True" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                    <label class="ml-2 block text-sm text-gray-900">Opt-in Opens</label>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" name="pedagogues[[INDEX_ARRAY]][opt_in_lates]" value="True" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                    <label class="ml-2 block text-sm text-gray-900">Opt-in Lates</label>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" name="pedagogues[[INDEX_ARRAY]][FLEX/FLOAT_staff]" value="True" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                    <label class="ml-2 block text-sm text-gray-900">FLEX/FLOAT Staff</label>
                </div>
                <div class="col-span-full flex justify-end">
                    <button type="button" onclick="removeStaffMember(this, 'pedagogue')" class="px-3 py-1 bg-red-500 text-white text-sm font-semibold rounded-md hover:bg-red-600">Remove</button>
                </div>
            </div>
        `;

        const assistantTemplate = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4 p-4 border border-purple-200 rounded-md bg-white staff-member-block">
                <div class="col-span-full text-lg font-semibold text-purple-700 mb-2">Assistant [INDEX_DISPLAY]</div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" name="assistants[[INDEX_ARRAY]][name]" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., A" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Age</label>
                    <input type="number" name="assistants[[INDEX_ARRAY]][age]" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Shift Time</label>
                    <input type="text" name="assistants[[INDEX_ARRAY]][shift_time]" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., 9:00 am - 6:00 pm" required>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" name="assistants[[INDEX_ARRAY]][certifification]" value="True" class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <label class="ml-2 block text-sm text-gray-900">Certified</label>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Availability</label>
                    <input type="text" name="assistants[[INDEX_ARRAY]][availability]" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., Mon-Fri" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Target Hours</label>
                    <input type="number" name="assistants[[INDEX_ARRAY]][Target]" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="col-span-full">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Soft Preferences</label>
                    <textarea name="assistants[[INDEX_ARRAY]][Soft_Preferences]" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., can do off in a week"></textarea>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" name="assistants[[INDEX_ARRAY]][opt_in_opens]" value="True" class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <label class="ml-2 block text-sm text-gray-900">Opt-in Opens</label>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" name="assistants[[INDEX_ARRAY]][opt_in_lates]" value="True" class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <label class="ml-2 block text-sm text-gray-900">Opt-in Lates</label>
                </div>
                <div class="col-span-full flex justify-end">
                    <button type="button" onclick="removeStaffMember(this, 'assistant')" class="px-3 py-1 bg-red-500 text-white text-sm font-semibold rounded-md hover:bg-red-600">Remove</button>
                </div>
            </div>
        `;

        const helperTemplate = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4 p-4 border border-yellow-200 rounded-md bg-white staff-member-block">
                <div class="col-span-full text-lg font-semibold text-yellow-700 mb-2">Helper [INDEX_DISPLAY]</div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" name="helpers[[INDEX_ARRAY]][name]" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., H" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Age</label>
                    <input type="number" name="helpers[[INDEX_ARRAY]][age]" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Shift Time</label>
                    <input type="text" name="helpers[[INDEX_ARRAY]][shift_time]" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., 9:00 am - 4:00 pm" required>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" name="helpers[[INDEX_ARRAY]][certifification]" value="True" class="h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
                    <label class="ml-2 block text-sm text-gray-900">Certified</label>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Availability</label>
                    <input type="text" name="helpers[[INDEX_ARRAY]][availability]" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., Mon-Fri" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Target Hours</label>
                    <input type="number" name="helpers[[INDEX_ARRAY]][Target]" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="col-span-full">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Soft Preferences</label>
                    <textarea name="helpers[[INDEX_ARRAY]][Soft_Preferences]" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., can come late for 2 hours"></textarea>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" name="helpers[[INDEX_ARRAY]][opt_in_opens]" value="True" class="h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
                    <label class="ml-2 block text-sm text-gray-900">Opt-in Opens</label>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" name="helpers[[INDEX_ARRAY]][opt_in_lates]" value="True" class="h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
                    <label class="ml-2 block text-sm text-gray-900">Opt-in Lates</label>
                </div>
                <div class="col-span-full flex justify-end">
                    <button type="button" onclick="removeStaffMember(this, 'helper')" class="px-3 py-1 bg-red-500 text-white text-sm font-semibold rounded-md hover:bg-red-600">Remove</button>
                </div>
            </div>
        `;

        // --- Dynamic Staff Generation Logic ---

        function generateStaffFields(type) {
            let countInputId;
            let containerId;
            let template;
            let staffTypeName;
            let defaultStaffArray; // To store default data

            if (type === 'pedagogue') {
                countInputId = 'no_of_pedagogues';
                containerId = 'pedagogue_fields_container';
                template = pedagogueTemplate;
                staffTypeName = 'Pedagogue';
                defaultStaffArray = defaultStaffData.pedagogues;
            } else if (type === 'assistant') {
                countInputId = 'no_of_assistants';
                containerId = 'assistant_fields_container';
                template = assistantTemplate;
                staffTypeName = 'Assistant';
                defaultStaffArray = defaultStaffData.assistants;
            } else if (type === 'helper') {
                countInputId = 'no_of_helpers';
                containerId = 'helper_fields_container';
                template = helperTemplate;
                staffTypeName = 'Helper';
                defaultStaffArray = defaultStaffData.helpers;
            }

            const desiredCount = parseInt(document.getElementById(countInputId).value || 0);
            const container = document.getElementById(containerId);
            const currentBlocks = container.querySelectorAll('.staff-member-block');

            // Store current values before clearing, to repopulate if the count increases again
            const currentValues = [];
            currentBlocks.forEach(block => {
                const values = {};
                block.querySelectorAll('input, textarea').forEach(input => {
                    const nameMatch = input.name.match(/\[\d+\]\[(.*?)\]/);
                    if (nameMatch && nameMatch[1]) {
                        const fieldName = nameMatch[1];
                        if (input.type === 'checkbox') {
                            values[fieldName] = input.checked; // Store boolean
                        } else {
                            values[fieldName] = input.value;
                        }
                    }
                });
                currentValues.push(values);
            });

            // Clear existing staff blocks
            container.innerHTML = '';

            // Generate new staff blocks up to the desired count
            for (let i = 0; i < desiredCount; i++) {
                const newBlock = document.createElement('div');
                newBlock.innerHTML = template
                    .replace(/\[INDEX_ARRAY\]/g, i)
                    .replace(/\[INDEX_DISPLAY\]/g, i + 1);

                // Determine which values to use: existing, default, or empty
                const valuesToApply = currentValues[i] || defaultStaffArray[i] || {};

                // Apply values to the newly created input elements
                newBlock.querySelectorAll('input, textarea').forEach(input => {
                    const nameMatch = input.name.match(/\[\d+\]\[(.*?)\]/);
                    if (nameMatch && nameMatch[1]) {
                        const fieldName = nameMatch[1];
                        if (valuesToApply[fieldName] !== undefined) {
                            if (input.type === 'checkbox') {
                                input.checked = Boolean(valuesToApply[fieldName]);
                            } else {
                                input.value = valuesToApply[fieldName];
                            }
                        }
                    }
                });

                const removeButton = newBlock.querySelector('button[onclick*="removeStaffMember"]');
                if (removeButton) {
                    if (desiredCount <= 1) {
                        removeButton.classList.add('hidden');
                    } else {
                        removeButton.classList.remove('hidden');
                    }
                }
                container.appendChild(newBlock);
            }
        }

        function removeStaffMember(buttonElement, type) {
            const blockToRemove = buttonElement.closest('.staff-member-block');
            blockToRemove.remove();

            let countInputId;
            if (type === 'pedagogue') {
                countInputId = 'no_of_pedagogues';
            } else if (type === 'assistant') {
                countInputId = 'no_of_assistants';
            } else if (type === 'helper') {
                countInputId = 'no_of_helpers';
            }

            const countInput = document.getElementById(countInputId);
            const currentCount = parseInt(countInput.value) || 0;
            if (currentCount > 0) {
                countInput.value = currentCount - 1;
            }

            generateStaffFields(type);
        }

        // --- Schedule Rendering Logic (Moved from previous response) ---
        const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

        // Function to sort time slots
        function sortTimeSlots(timeSlots) {
            return timeSlots.sort((a, b) => {
                const [aStartHour, aStartMinute] = a.split(' - ')[0].split(':').map(Number);
                const [bStartHour, bStartMinute] = b.split(' - ')[0].split(':').map(Number);

                if (aStartHour !== bStartHour) {
                    return aStartHour - bStartHour;
                }
                return aStartMinute - bStartMinute;
            });
        }

        function renderScheduleTables(scheduleData) {
            const dynamicScheduleContainer = document.getElementById('dynamic_schedule_tables');
            dynamicScheduleContainer.innerHTML = ''; // Clear previous tables

            if (!scheduleData || !scheduleData.Month) {
                dynamicScheduleContainer.innerHTML = '<p class="text-red-500">No schedule data available or invalid format.</p>';
                return;
            }

            // Iterate through each week in the schedule data
            for (const weekKey in scheduleData.Month) {
                if (scheduleData.Month.hasOwnProperty(weekKey)) {
                    const weekData = scheduleData.Month[weekKey];

                    // Create a div for each week's schedule
                    const weekDiv = document.createElement('div');
                    weekDiv.classList.add('schedule-week');

                    // Add a title for the week (e.g., "WEEK 1 Schedule")
                    const weekTitle = document.createElement('h2');
                    weekTitle.textContent = weekKey.replace('-', ' '); // Replace hyphen for better display
                    weekDiv.appendChild(weekTitle);

                    // Create the table element
                    const table = document.createElement('table');
                    const thead = document.createElement('thead');
                    const tbody = document.createElement('tbody');

                    // Create table header row with "Time Slot" and days of the week
                    const headerRow = document.createElement('tr');
                    const timeHeader = document.createElement('th');
                    timeHeader.textContent = "Time Slot";
                    headerRow.appendChild(timeHeader);

                    daysOfWeek.forEach(day => {
                        const th = document.createElement('th');
                        th.textContent = day;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    // Collect all unique time slots across all days for the current week
                    const allTimeSlots = new Set();
                    for (const dayKey in weekData) {
                        if (weekData.hasOwnProperty(dayKey)) {
                            const dayName = daysOfWeek[parseInt(dayKey.split('-')[1]) - 1]; // Get the actual day name (e.g., "Monday")
                            const daySchedule = weekData[dayKey] ? weekData[dayKey][dayName] : undefined;
                            if (daySchedule) {
                                for (const timeSlot in daySchedule) {
                                    if (daySchedule.hasOwnProperty(timeSlot)) {
                                        allTimeSlots.add(timeSlot);
                                    }
                                }
                            }
                        }
                    }
                    const sortedTimeSlots = sortTimeSlots(Array.from(allTimeSlots)); // Sort time slots

                    // Populate table body with rows for each time slot
                    sortedTimeSlots.forEach(timeSlot => {
                        const row = document.createElement('tr');
                        const timeCell = document.createElement('td');
                        timeCell.textContent = timeSlot;
                        row.appendChild(timeCell);

                        // Iterate through each day of the week to get activities for the current time slot
                        daysOfWeek.forEach((dayName, dayIndex) => {
                            const dayKey = `Day-${dayIndex + 1}`;
                            const dailySchedule = weekData[dayKey] ? weekData[dayKey][dayName] : {};
                            const activities = dailySchedule ? dailySchedule[timeSlot] : undefined;

                            const activityCell = document.createElement('td');
                            if (activities) {
                                if (Array.isArray(activities)) {
                                    // If activities is an array, iterate and display each activity
                                    activities.forEach(activity => {
                                        const activityDiv = document.createElement('div');
                                        activityDiv.classList.add('activity-item');
                                        activityDiv.innerHTML = `<strong>${activity.NAME.replace(/\*\*/g, '')}</strong>` + // Remove bold markdown
                                                                `<span>Time: ${activity['start-end']}</span>` +
                                                                `<span>Room(s): ${activity['ROOM(S)']}</span>` +
                                                                `<span>Break: ${activity.break}</span>`;
                                        if (activity.NOTES) {
                                            activityDiv.innerHTML += `<span class="notes">Notes: ${activity.NOTES}</span>`;
                                        }
                                        activityCell.appendChild(activityDiv);
                                    });
                                } else {
                                    // If activities is a string (like the cleanup note), display it directly
                                    const activityDiv = document.createElement('div');
                                    activityDiv.classList.add('activity-item');
                                    activityDiv.textContent = activities;
                                    activityCell.appendChild(activityDiv);
                                }
                            } else {
                                activityCell.textContent = ""; // Empty cell if no activity for this slot/day
                            }
                            row.appendChild(activityCell);
                        });
                        tbody.appendChild(row);
                    });

                    table.appendChild(tbody);
                    weekDiv.appendChild(table);
                    dynamicScheduleContainer.appendChild(weekDiv);
                }
            }
        }


        // --- Form Submission Logic (Connecting to Django Backend) ---

        async function Kindergarten(event) {
            event.preventDefault(); // Prevent default form submission (page reload)

            // Show loading spinner and hide previous output/errors
            document.getElementById('loading_spinner').classList.remove('hidden');
            document.getElementById('schedule_output_section').classList.add('hidden');
            document.getElementById('error_message').classList.add('hidden');
            document.getElementById('dynamic_schedule_tables').innerHTML = ''; // Clear previous tables

            const form = event.target;
            const formData = new FormData(form);
            const data = {};

            function processFormData(formData) {
                const result = {};
                
                // Collect direct form fields
                for (const [key, value] of formData.entries()) {
                    if (!key.includes('[') && !key.includes(']')) { // Not array or object fields
                        result[key] = value;
                    }
                }

                // Handle nested array inputs like pedagogues[0][name]
                const staffTypes = ['pedagogues', 'assistants', 'helpers'];
                staffTypes.forEach(staffType => {
                    result[staffType] = [];
                    const staffBlocks = document.querySelectorAll(`#${staffType}_fields_container .staff-member-block`);
                    staffBlocks.forEach((block, index) => {
                        const staffMember = {};
                        block.querySelectorAll('input, textarea').forEach(input => {
                            const nameMatch = input.name.match(/\[\d+\]\[(.*?)\]/);
                            if (nameMatch && nameMatch[1]) {
                                const fieldName = nameMatch[1];
                                if (input.type === 'checkbox') {
                                    staffMember[fieldName] = input.checked; // Store as boolean
                                } else {
                                    staffMember[fieldName] = input.value;
                                }
                            }
                        });
                        result[staffType].push(staffMember);
                    });
                });

                // Handle hard_constraints as an object
                result.hard_constraints = {};
                for (let [key, value] of formData.entries()) {
                    if (key.startsWith('hard_constraints[')) {
                        const constraintMatch = key.match(/hard_constraints\[(.+)\]/);
                        if (constraintMatch) {
                            const constraintName = constraintMatch[1];
                            result.hard_constraints[constraintName] = value;
                        }
                    }
                }
                
                // Convert numbers from strings to actual numbers
                result.no_of_pedagogues = parseInt(result.no_of_pedagogues) || 0;
                result.no_of_assistants = parseInt(result.no_of_assistants) || 0;
                result.no_of_helpers = parseInt(result.no_of_helpers) || 0;
                result.total_staff = result.no_of_pedagogues + result.no_of_assistants + result.no_of_helpers; // Recalculate based on input fields
                result.rooms = parseInt(result.rooms) || 0;

                staffTypes.forEach(staffType => {
                    if (result[staffType]) {
                        result[staffType].forEach(staff => {
                            staff.age = parseInt(staff.age) || 0;
                            staff.Target = parseInt(staff.Target) || 0;
                            // Ensure boolean fields are actually booleans, not strings from HTML `value` or undefined
                            staff.certifification = Boolean(staff.certifification);
                            staff.opt_in_opens = Boolean(staff.opt_in_opens);
                            staff.opt_in_lates = Boolean(staff.opt_in_lates);
                            if (staffType === 'pedagogues') {
                                staff['FLEX/FLOAT_staff'] = Boolean(staff['FLEX/FLOAT_staff']);
                            }
                        });
                    }
                });

                return result;
            }

            const structuredData = processFormData(formData);
            console.log("Sending to backend:", structuredData); // Log the data being sent

            try {
                const response = await fetch(DJANGO_BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // If you implement CSRF token, add it here:
                        // 'X-CSRFToken': getCookie('csrftoken'), 
                    },
                    body: JSON.stringify(structuredData),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Network response was not ok.');
                }

                const result = await response.json();
                console.log("Received from backend:", result); // Log the data received

                // Parse the GPT provided schedule string into a JSON object
                let gptScheduleJson = {};
                try {
                    // Check if result.Gpt_provided_schedule is a string before parsing
                    if (typeof result.Gpt_provided_schedule === 'string') {
                        gptScheduleJson = JSON.parse(result.Gpt_provided_schedule);
                    } else {
                        // If it's already an object, use it directly
                        gptScheduleJson = result.Gpt_provided_schedule;
                    }
                } catch (parseError) {
                    console.error("Error parsing Gpt_provided_schedule:", parseError);
                    document.getElementById('error_text').textContent = "Error parsing generated schedule data. Please check the format.";
                    document.getElementById('error_message').classList.remove('hidden');
                    return; // Stop execution if parsing fails
                }
                
                // Render the schedule tables
                renderScheduleTables(gptScheduleJson);
                
                // --- CORRECTED MODEL REPORT POPULATION ---
                document.getElementById('model_report_text').textContent = result['model report']['Response report'];
                const modelReportDetailsList = document.getElementById('model_report_details'); // Correctly define it here
                modelReportDetailsList.innerHTML = ''; // Clear existing list items

                // Ensure 'details' exists within 'model report' and is an array
                document.getElementById('model_report_text').textContent = result['model report']['Response report'];
                const reportDetailsList = document.getElementById('model_report_details');
                reportDetailsList.innerHTML = '';
                // --- END CORRECTED MODEL REPORT POPULATION ---

                // Populate KPIs
                // Ensure 'Fairness Score' and 'score' exist before accessing
                const fairnessScore = result['Fairness Score'] && result['Fairness Score'].score !== undefined
                    ? result['Fairness Score'].score
                    : null;
                const fairnessScoreElem = document.getElementById('fairness_score_output');
                if (fairnessScore !== null) {
                    fairnessScoreElem.textContent = `${fairnessScore}%`;
                    fairnessScoreElem.closest('.progress-circle').style.setProperty('--progress', `${fairnessScore}%`);
                } else {
                    fairnessScoreElem.textContent = 'N/A';
                }

                const hardRuleViolations = result['Hard Rule Violation Count'];
                const hardRuleElem = document.getElementById('hard_rule_violations_output');

                if (Array.isArray(hardRuleViolations) && hardRuleViolations.length > 0) {
                    // Show violations in red, as a list
                    hardRuleElem.innerHTML = hardRuleViolations.map(v => `<div style="color:#dc2626;font-weight:bold;">${v}</div>`).join('');
                } else if (hardRuleViolations === false) {
                    // Show a green checkmark and positive message
                    hardRuleElem.innerHTML = `<span style="color:#16a34a;font-weight:bold;">&#10003; No rule has been violated so far.</span>`;
                } else {
                    // Fallback
                    hardRuleElem.textContent = hardRuleViolations || 'N/A';
                }

                document.getElementById('correction_time_output').textContent = result['Correction Time'] !== undefined ? result['Correction Time'] : 'N/A';
                
                // Populate Resource Utilization
                document.getElementById('input_token_output').textContent = result.tokens_details && result.tokens_details.input_token !== undefined ? result.tokens_details.input_token.toLocaleString() : 'N/A';
                document.getElementById('output_token_output').textContent = result.tokens_details && result.tokens_details.output_token !== undefined ? result.tokens_details.output_token.toLocaleString() : 'N/A';
                document.getElementById('token_cost_output').textContent = result.tokens_details && result.tokens_details.cost !== undefined ? `$${result.tokens_details.cost.toFixed(6)}` : 'N/A';
                
                document.getElementById('total_cost_output').textContent = result.Total_cost !== undefined ? `$${result.Total_cost.toFixed(6)}` : 'N/A';
                document.getElementById('model_output').textContent = result.model !== undefined ? result.model : 'N/A';


                // Show the output section
                document.getElementById('schedule_output_section').classList.remove('hidden');

            } catch (error) {
                console.error('Error submitting form:', error);
                document.getElementById('error_text').textContent = error.message;
                document.getElementById('error_message').classList.remove('hidden');
            } finally {
                // Hide loading spinner regardless of success or failure
                document.getElementById('loading_spinner').classList.add('hidden');
            }
        }

        // --- Initial Load Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // Populate initial staff fields based on default 'value' attributes in the input fields
            // and the `defaultStaffData` object.
            
            // Set default dates for date inputs
            document.getElementById('starting_date').value = "2024-06-01";
            document.getElementById('ending_date').value = "2024-06-30";

            // Trigger generation for each staff type to populate with defaults
            generateStaffFields('pedagogue');
            generateStaffFields('assistant');
            generateStaffFields('helper');
        });

        // Function to get CSRF token (needed if @csrf_exempt is removed in production)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
